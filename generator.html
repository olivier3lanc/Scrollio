<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Scrollshow generator</title>
    <meta name="description" content="Generate your own Scrollshow.">
    <!-- Scrollshow generator -->
    <link href="./build/scrollshow.generator.min.css" rel="stylesheet">
    <!-- Scrollshow core -->
    <link href="build/scrollshow.min.css" rel="stylesheet">
    <!-- Scrollshow Theme -->
    <link href="build/scrollshow.theme.venus.min.css" rel="stylesheet">
</head>

<body>
    <header id="topbar">
        <h1>Scrollshow generator</h1>
        <nav>
            <button name="generate">generate</button>
        </nav>
    </header>

    <div id="scrollshow" class="edit-mode">
        <div class="item">
            <h1>My first item</h1>
        </div>
    </div>

    <div id="generator" class="edit-mode">
        <div class="wrapper">
            <div class="commands">
                <button type="button" name="add">add</button>
            </div>
            <div class="settings"></div>
        </div>
    </div>

    <!-- jQuery -->
    <script type="text/javascript" src="libraries/jquery/jquery-3.3.1.min.js"></script>
    <!-- Scrollshow lib -->
    <script type="text/javascript" src="build/scrollshow.min.js"></script>
    <!-- Initialize -->
    <script type="text/javascript">
        var currentScrollshowParameters = jQuery.fn.scrollshow('get:all');

        jQuery.fn.scrollshow();

        var decode = function() {
            var theHash = window.location.hash;
            if(theHash != ''){
                var encodedHash = theHash.replace('#','');
                var decodedString = window.atob(encodedHash);
                console.log(decodedString);

                var objRecognized = JSON.parse(decodedString);
                console.log(objRecognized);

                if(typeof objRecognized == 'object'){
                    console.log(Object.keys(objRecognized).length);
                    //Destroy instance
                    jQuery('#scrollshow').remove();
                    //Build a new one
                    jQuery('body').append('<div id="scrollshow" class="edit-mode"></div>');
                    var jQ_scrollshow = jQuery('#scrollshow');
                    for (var i = 0; i < Object.keys(objRecognized).length; i++) {
                        console.log(typeof objRecognized[i]);

                        //if it is a string, it is content
                        if(typeof objRecognized[i] == 'string'){
                            jQ_scrollshow.append(
                                '<div class="item">'+
                                    objRecognized[i]+
                                '</div>'
                            );
                        }
                    }
                    //
                    var customParameters = {};
                    if(typeof objRecognized.options == 'object'){
                        console.log('options found');
                        //Manage parameters
                        var userProperties = Object.getOwnPropertyNames(objRecognized.options);
                        //Replace each parameter by its new value
                        userProperties.forEach(function(property){
                            if(currentScrollshowParameters.hasOwnProperty(property)){
                                customParameters[property] = objRecognized.options[property];
                                currentScrollshowParameters[property] = objRecognized.options[property];
                            }
                        });
                    }
                    console.log('custom params');
                    console.log(customParameters);

                    jQuery.fn.scrollshow(customParameters);
                    updateEdits();
                    updateListeners();
                }
            }
        }

        var editorPattern = function(text = ''){
            var pattern =   '<div class="item">'+
                                '<nav>'+
                                    '<button name="remove">remove</button>'+
                                '</nav>'+
                                '<textarea>'+text+'</textarea>'+
                            '</div>';
            return pattern;
        }

        var updateEdits = function(){
            jQuery('#generator').find('.item').remove();
            var amount = jQuery('#scrollshow .item h1').length;
            jQuery('#scrollshow .item h1').each(function(index){
                var jQ_html = jQuery(this).clone();
                jQ_html.find('.word').eq(-1).remove();
                // jQ_html.find('.separator').eq(-1).remove();
                var text = jQ_html.text();
                // var textEllipsis = jQuery.fn.scrollshow('get:textEllipsis');
                // var textEllipsis = currentScrollshowParameters.textEllipsis;
                // var text = jQuery(this).text();
                // text = text.replace(' '+textEllipsis,'');
                var pattern = editorPattern(text);
                // var pattern =   '<div class="item">'+
                //                     '<textarea>'+text+'</textarea>'+
                //                 '</div>';
                //For the first
                if(index == 0){
                    jQuery('#generator .wrapper').prepend(pattern);
                }else{
                    jQuery('#generator').find('.item').eq(-1).after(pattern);
                }
            });
            //parameters
            jQuery('#generator .settings').html('');
            var settingsParameters = Object.getOwnPropertyNames(currentScrollshowParameters);
            settingsParameters.forEach(function(property){
                var type = typeof currentScrollshowParameters[property];
                var form;
                if(property != 'id' && type != 'function'){
                    if(type == 'boolean'){
                        var checkMarkup = 'checked';
                        var checkTrueStatus = '';
                        var checkFalseStatus = '';
                        if(currentScrollshowParameters[property]){
                            checkTrueStatus = checkMarkup;
                        }else{
                            checkFalseStatus = checkMarkup;
                        }
                        form =  '<input type="radio" id="'+property+'-true" name="'+property+'" '+checkTrueStatus+'>'+
                                '<label for="'+property+'-true">true</label> '+
                                '<input type="radio" id="'+property+'-false" name="'+property+'" '+checkFalseStatus+'>'+
                                '<label for="'+property+'-false">false</label>';
                    }else if(type == 'string'){
                        form = '<input type="text" id="'+property+'" name="'+property+'" value="'+currentScrollshowParameters[property]+'">';
                    }else if(type == 'number'){
                        form = '<input type="number" id="'+property+'"  name="'+property+'" value="'+currentScrollshowParameters[property]+'">';
                    }
                    jQuery('#generator .settings').append(
                        '<fieldset><legend>'+property+'</legend> '+form+'</fieldset>'
                    );
                }
            });
        }

        var updateListeners = function(){
            jQuery('#scrollshow h1')
                .off()
                .on('click',function(e){


                    // var textEllipsis = jQuery.fn.scrollshow('textEllipsis');
                    // var text = jQuery(this).text();
                    // text = text.replace(textEllipsis,'');
                    var itemIndex = jQuery(this).parent().index();
                    // jQuery('#scrollshow,#generator').addClass('edit-mode');
                    jQuery('#generator textarea').eq(itemIndex)
                        .focus()
                        .select();
                });
            jQuery('#generator button[name="remove"]')
                .off()
                .on('click',function(){
                    jQuery(this).closest('.item').remove();
                });
        }



        updateEdits();
        updateListeners();


        jQuery('button[name="add"]').on('click',function(){
            var pattern = editorPattern();
            jQuery('#generator').find('.item').eq(-1).after(pattern);
            jQuery('#generator').find('.item').eq(-1).find('textarea').focus().select();
            updateListeners();
        });
        jQuery('button[name="generate"]').on('click',function(){
            var obj = { options: {}};
            var index = 0;
            jQuery('#scrollshow').removeClass('initialized');
            jQuery('#generator').find('.item').each(function(){
                // var index = jQuery(this).index();
                var text = jQuery(this).find('textarea').val();
                if(text != ''){
                    obj[index] = '<h1>'+text+'</h1>';
                    index++;
                }
            });
            //get user parameters
            jQuery('#generator .settings input').each(function(){
                var parameter = jQuery(this).attr('name');
                if(jQuery(this).attr('type') == 'radio'){
                    var value = jQuery('input[type="radio"][name="'+parameter+'"]').prop('checked');
                }else if(jQuery(this).attr('type') == 'number'){
                    var value = parseFloat(jQuery(this).val());
                }else if(jQuery(this).attr('type') == 'text'){
                    var value = jQuery(this).val();
                }
                obj.options[parameter] = value;
                currentScrollshowParameters[parameter] = value;
            });
            var myJSON = JSON.stringify(obj);
            var encodedString = window.btoa( myJSON );
            console.log(encodedString);
            window.location.hash = encodedString;
            console.log(encodedString);
            jQuery(window).scrollTop(0);
            setTimeout(function(){
                decode();
            },100);


            // jQuery('#scrollshow,#generator').removeClass('edit-mode');


        });

    </script>
</body>

</html>
