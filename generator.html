<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Scrollshow generator</title>
    <meta name="description" content="Generate your own Scrollshow.">
    <!-- Scrollshow generator -->
    <link href="./build/scrollshow.generator.min.css" rel="stylesheet">
    <!-- Scrollshow core -->
    <link href="build/scrollshow.min.css" rel="stylesheet">
    <!-- Scrollshow Theme -->
    <link href="build/scrollshow.theme.venus.min.css" rel="stylesheet">
</head>

<body>
    <header>
        <h1>Scrollshow generator</h1>
        <nav>
            <button name="generate">generate</button>
        </nav>
    </header>

    <div id="scrollshow" class="edit-mode">
        <div class="item">
            <h1>My first item</h1>
        </div>
    </div>

    <div id="generator" class="edit-mode">
        <div class="wrapper">
            <div class="commands">
                <button type="button" name="add">add</button>
            </div>
        </div>
    </div>

    <footer>

    </footer>

    <!-- jQuery -->
    <script type="text/javascript" src="libraries/jquery/jquery-3.3.1.min.js"></script>
    <!-- Scrollshow lib -->
    <script type="text/javascript" src="build/scrollshow.min.js"></script>
    <!-- Initialize -->
    <script type="text/javascript">
        jQuery.fn.scrollshow();

        var decode = function() {
            var theHash = window.location.hash;
            if(theHash != ''){
                var encodedHash = theHash.replace('#','');
                var decodedString = window.atob(encodedHash);
                console.log(decodedString);

                var objRecognized = JSON.parse(decodedString);
                console.log(objRecognized);

                if(typeof objRecognized == 'object'){
                    console.log(Object.keys(objRecognized).length);
                    var jQ_scrollshow = jQuery('#scrollshow');
                    jQ_scrollshow.html('');
                    for (var i = 0; i < Object.keys(objRecognized).length; i++) {
                        console.log(typeof objRecognized[i]);
                        jQ_scrollshow.append(
                            '<div class="item">'+
                                objRecognized[i]+
                            '</div>'
                        );
                        //if it is a string, it is content
                        if(typeof objRecognized == 'string'){

                        }
                        //
                        if(typeof objRecognized == 'object'){
                            // jQ_scrollshow.append(
                            //     '<div class="item">'+
                            //         objRecognized[i]+
                            //     '</div>'
                            // );
                        }
                    }
                    jQuery.fn.scrollshow();
                }
            }
        }

        var editorPattern = function(text = ''){
            var pattern =   '<div class="item">'+
                                '<nav>'+
                                    '<button name="remove">remove</button>'+
                                '</nav>'+
                                '<textarea>'+text+'</textarea>'+
                            '</div>';
            return pattern;
        }

        var updateEdits = function(){
            jQuery('#generator').find('.item').remove();
            var amount = jQuery('#scrollshow h1').length;
            jQuery('#scrollshow h1').each(function(index){
                // var jQ_html = jQuery(this).clone();
                // jQ_html.find('.word').eq(-1).remove();
                // var text = jQ_html.text();
                var textEllipsis = jQuery.fn.scrollshow('textEllipsis');
                var text = jQuery(this).text();
                text = text.replace(' '+textEllipsis,'');
                var pattern = editorPattern(text);
                // var pattern =   '<div class="item">'+
                //                     '<textarea>'+text+'</textarea>'+
                //                 '</div>';
                //For the first
                if(index == 0){
                    jQuery('#generator .wrapper').prepend(pattern);
                    console.log('Ã©gal 0');
                }else{
                    jQuery('#generator').find('.item').eq(-1).after(pattern);
                    console.log('insert after');
                }
            });
        }

        var updateListeners = function(){
            jQuery('#scrollshow h1')
                .off()
                .on('click',function(e){


                    // var textEllipsis = jQuery.fn.scrollshow('textEllipsis');
                    // var text = jQuery(this).text();
                    // text = text.replace(textEllipsis,'');
                    var itemIndex = jQuery(this).parent().index();
                    // jQuery('#scrollshow,#generator').addClass('edit-mode');
                    jQuery('#generator textarea').eq(itemIndex)
                        .focus()
                        .select();
                });
            jQuery('#generator button[name="remove"]')
                .off()
                .on('click',function(){
                    jQuery(this).closest('.item').remove();
                });
        }



        updateEdits();
        updateListeners();


        jQuery('button[name="add"]').on('click',function(){
            var pattern = editorPattern();
            jQuery('#generator').find('.item').eq(-1).after(pattern);
            jQuery('#generator').find('.item').eq(-1).find('textarea').focus().select();
            updateListeners();
        });
        jQuery('button[name="generate"]').on('click',function(){
            var obj = {};
            var index = 0;
            jQuery('#scrollshow').removeClass('initialized');
            jQuery('#generator').find('.item').each(function(){
                // var index = jQuery(this).index();
                var text = jQuery(this).find('textarea').val();
                if(text != ''){
                    obj[index] = '<h1>'+text+'</h1>';
                    index++;
                }
            });
            var myJSON = JSON.stringify(obj);
            var encodedString = window.btoa( myJSON );
            console.log(encodedString);
            window.location.hash = encodedString;
            console.log(encodedString);
            decode();

            // jQuery('#scrollshow,#generator').removeClass('edit-mode');
            jQuery(window).scrollTop(0);
            updateEdits();
            updateListeners();
        });

    </script>
</body>

</html>
